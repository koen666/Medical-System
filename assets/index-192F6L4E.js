import{_ as U,k as S,o,l as a,b as n,a as r,g as T,m as s,t as _,f as $,p as l,F as V,e as D,q as I,s as j,x as G,z as H,y as K,A as O,B as P,n as B,C as W,D as Y,G as q,H as Q,E as b,I as X,J,K as Z,L as x,M as ee,N as te,O as se,d as ae,T as ne,P as L,Q as le,R as oe,S as ie,U as re,V as de,W as ce,X as ue,Y as pe,Z as A,$ as me,a0 as he}from"./index-C6aXvd6r.js";const fe={class:"info"},ge={class:"primary"},_e={class:"meta"},ye={key:0,class:"alerts"},ve={key:1,class:"allergies"},be={class:"actions"},$e={__name:"PatientHeader",props:{patient:{type:Object,required:!0},visitId:{type:String,required:!0}},emits:["sync","export"],setup(e,{emit:t}){const i=t;return(p,u)=>{const h=l("el-tag"),m=l("el-button"),f=l("el-card");return o(),S(f,{shadow:"never",class:"patient-header"},{default:a(()=>[n("div",fe,[n("div",ge,[n("h2",null,_(e.patient.name),1),s(h,{type:e.patient.gender==="男"?"primary":"danger",size:"small"},{default:a(()=>[$(_(e.patient.gender),1)]),_:1},8,["type"]),s(h,{size:"small"},{default:a(()=>[$(_(e.patient.age)+" 岁",1)]),_:1})]),n("div",_e,[n("span",null,"就诊类型："+_(e.patient.visitType),1),n("span",null,"就诊时间："+_(e.patient.visitTime),1),n("span",null,"就诊号："+_(e.visitId),1)]),e.patient.alerts&&e.patient.alerts.length?(o(),r("div",ye,[(o(!0),r(V,null,D(e.patient.alerts,c=>(o(),S(h,{key:c,type:"warning",size:"small"},{default:a(()=>[$(_(c),1)]),_:2},1024))),128))])):T("",!0),e.patient.allergies&&e.patient.allergies.length?(o(),r("div",ve,[u[2]||(u[2]=$(" 过敏史： ",-1)),(o(!0),r(V,null,D(e.patient.allergies,c=>(o(),S(h,{key:c,type:"danger",size:"small"},{default:a(()=>[$(_(c),1)]),_:2},1024))),128))])):T("",!0)]),n("div",be,[s(m,{type:"primary",icon:I(j),onClick:u[0]||(u[0]=c=>i("sync"))},{default:a(()=>[...u[3]||(u[3]=[$("写回 EMR",-1)])]),_:1},8,["icon"]),s(m,{icon:I(G),onClick:u[1]||(u[1]=c=>i("export"))},{default:a(()=>[...u[4]||(u[4]=[$("导出摘要",-1)])]),_:1},8,["icon"])])]),_:1})}}},ke=U($e,[["__scopeId","data-v-20855dea"]]),we={class:"side-toolbar"},Se={__name:"SideToolbar",emits:["density-change","open-shortcuts"],setup(e,{emit:t}){const i=t;return(p,u)=>{const h=l("el-button"),m=l("el-tooltip");return o(),r("div",we,[s(m,{content:"切换信息密度",placement:"left"},{default:a(()=>[s(h,{circle:"",icon:I(H),size:"small",onClick:u[0]||(u[0]=f=>i("density-change"))},null,8,["icon"])]),_:1}),s(m,{content:"快捷键说明",placement:"left"},{default:a(()=>[s(h,{circle:"",icon:I(K),size:"small",type:"primary",onClick:u[1]||(u[1]=f=>i("open-shortcuts"))},null,8,["icon"])]),_:1}),s(m,{content:"导出设置（演示中禁用）",placement:"left"},{default:a(()=>[s(h,{circle:"",icon:I(O),size:"small",disabled:""},null,8,["icon"])]),_:1})])}}},Te=U(Se,[["__scopeId","data-v-94feafb3"]]),Ce=P({name:"SymptomInputPanel",components:{MagicStick:Q,Refresh:q,Microphone:Y,Loading:W,UploadFilled:j},props:{templates:{type:Array,default:()=>[]}},data(){return{activeTab:"text",textContent:"",voiceTranscription:"",isRecording:!1,uploading:!1,recordStartAt:null,recordTimer:null,recordDuration:"00:00",recordedUrl:"",docExtraction:[],mediaStream:null,mediaRecorder:null,audioChunks:[]}},methods:{startRecordTimer(){this.clearRecordTimer(),this.recordStartAt=Date.now(),this.recordDuration="00:00",this.recordTimer=setInterval(()=>{const e=Math.floor((Date.now()-this.recordStartAt)/1e3),t=String(Math.floor(e/60)).padStart(2,"0"),i=String(e%60).padStart(2,"0");this.recordDuration=`${t}:${i}`},1e3)},applyTemplate(e){this.textContent=`${this.textContent}
${e}`.trim()},async toggleRecording(){this.isRecording?await this.stopRecording():await this.startRecording()},async startRecording(){try{this.voiceTranscription="",this.uploading=!1,this.audioChunks=[],this.recordedUrl="",this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0});const e="audio/webm";this.mediaRecorder=new MediaRecorder(this.mediaStream,{mimeType:e}),this.mediaRecorder.ondataavailable=t=>{t.data&&t.data.size>0&&this.audioChunks.push(t.data)},this.mediaRecorder.onstop=async()=>{const t=new Blob(this.audioChunks,{type:e});this.recordedUrl&&URL.revokeObjectURL(this.recordedUrl),this.recordedUrl=URL.createObjectURL(t),await this.uploadAndTranscribe(t),this.mediaStream&&(this.mediaStream.getTracks().forEach(i=>i.stop()),this.mediaStream=null),this.clearRecordTimer()},this.startRecordTimer(),this.isRecording=!0,this.mediaRecorder.start(),b.info("录音已开始")}catch(e){console.error(e),b.error("无法开始录音，请检查麦克风权限或浏览器支持"),this.clearRecordTimer()}},async stopRecording(){try{this.mediaRecorder&&this.isRecording&&(this.isRecording=!1,this.mediaRecorder.stop(),b.info("录音已停止，开始识别..."),this.clearRecordTimer())}catch(e){console.error(e),b.error("停止录音失败"),this.clearRecordTimer()}},clearRecordTimer(){this.recordTimer&&(clearInterval(this.recordTimer),this.recordTimer=null),this.recordStartAt=null},async uploadAndTranscribe(e){try{this.uploading=!0;const t=new FormData;t.append("audio",e,"recording.webm");const i=await fetch("http://localhost:5000/api/medical/audio2text",{method:"POST",body:t}),p=await i.json();if(i.ok&&p){const h=(p.text||"").replace(/^这段音频的原始内容是[:：]\s*/i,"").trim();this.voiceTranscription=h,b.success("语音识别完成")}else b.error(p?.error||"识别失败")}catch(t){console.error(t),b.error("上传或识别过程出错")}finally{this.uploading=!1}},resetInputs(){this.textContent="",this.voiceTranscription="",this.docExtraction=[],this.recordedUrl&&(URL.revokeObjectURL(this.recordedUrl),this.recordedUrl=""),this.clearRecordTimer(),b.info("已重置输入内容")},async simulateDocParse(e){const t=e.raw;if(!t){b.warning("未找到文件");return}["image/png","image/jpeg","image/jpg","image/gif","image/bmp"].includes(t.type)?await this.extractTextFromImage(t):(b.info(`模拟解析 ${t.name}`),this.docExtraction=[{time:"2025-09-24 08:30",title:"门诊问诊摘要",content:"主诉：48小时搏动性头痛，伴恶心畏光。既往偏头痛史。"},{time:"2025-09-24 09:00",title:"体格检查",content:"神经系统查体(-)，无颈抵抗。血压 130/85mmHg。"}])},async extractTextFromImage(e){try{b.info("正在识别图片中的文字...");const t=new FormData;t.append("image",e);const i=await fetch("http://localhost:5000/api/medical/image2text",{method:"POST",body:t}),p=await i.json();if(i.ok&&p&&p.text){const u=new Date().toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).replace(/\//g,"-");this.docExtraction=[{time:u,title:"图片文字识别结果",content:p.text}],this.textContent=p.text,this.activeTab="text",b.success("图片文字识别完成")}else b.error(p?.error||"图片识别失败")}catch(t){console.error(t),b.error("图片识别过程出错")}},buildDemoSymptoms(){return[{code:"S-0001",label:"搏动性头痛",severity:"中",duration:"48小时",side:"双侧",weight:.8,negated:!1},{code:"S-0045",label:"恶心伴呕吐",severity:"轻",duration:"24小时",side:"全身",weight:.6,negated:!1},{code:"S-0120",label:"畏光",severity:"轻",duration:"48小时",side:"双眼",weight:.4,negated:!1}]},async emitExtraction(){let e="";if(this.activeTab==="text"?e=this.textContent:this.activeTab==="voice"?e=this.voiceTranscription:this.activeTab==="document"&&this.docExtraction.length>0&&(e=this.docExtraction.map(t=>t.content).join(`
`)),!e||!e.trim()){b.warning("请先输入或录入症状信息");return}try{b.info("正在提取症状关键词...");const t=await fetch("http://localhost:5000/api/medical/extract_keywords",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})}),i=await t.json();if(t.ok&&i&&i.keywords){const h=i.keywords.split(/[,，]/).map(m=>m.trim()).filter(m=>m).map((m,f)=>({code:`S-${String(f+1).padStart(4,"0")}`,label:m,severity:"中",duration:"未指定",side:"全身",weight:.8-f*.1,negated:!1}));this.$emit("symptoms-extracted",h),b.success(`已提取 ${h.length} 条症状关键词`)}else{b.warning("关键词提取失败，使用演示数据");const p=this.buildDemoSymptoms();this.$emit("symptoms-extracted",p)}}catch(t){console.error(t),b.error("提取关键词时出错，使用演示数据");const i=this.buildDemoSymptoms();this.$emit("symptoms-extracted",i)}}},beforeUnmount(){this.recordedUrl&&URL.revokeObjectURL(this.recordedUrl),this.mediaStream&&this.mediaStream.getTracks().forEach(e=>e.stop()),this.clearRecordTimer()}}),Ve={class:"symptom-input-panel"},De={class:"text-input"},Me={key:0,class:"templates"},Ue={class:"voice-input"},Pe={class:"voice-controls"},Fe={key:0,class:"voice-status"},Re={key:1,class:"voice-status"},Ie=["src"],ze={class:"document-input"},Ee={class:"actions"};function Ae(e,t,i,p,u,h){const m=l("el-input"),f=l("el-tag"),c=l("el-alert"),v=l("el-tab-pane"),d=l("el-button"),y=l("Loading"),g=l("el-icon"),M=l("UploadFilled"),R=l("el-upload"),F=l("el-card"),C=l("el-timeline-item"),E=l("el-timeline"),w=l("el-tabs");return o(),r("div",Ve,[s(w,{modelValue:e.activeTab,"onUpdate:modelValue":t[2]||(t[2]=k=>e.activeTab=k),stretch:""},{default:a(()=>[s(v,{label:"文本输入",name:"text"},{default:a(()=>[n("div",De,[s(m,{type:"textarea",modelValue:e.textContent,"onUpdate:modelValue":t[0]||(t[0]=k=>e.textContent=k),autosize:{minRows:6,maxRows:12},placeholder:"请输入或粘贴问诊得到的症状信息，可使用快捷模板"},null,8,["modelValue"]),e.templates&&e.templates.length?(o(),r("div",Me,[t[3]||(t[3]=n("span",{class:"templates-label"},"快捷模板：",-1)),(o(!0),r(V,null,D(e.templates,k=>(o(),S(f,{key:k.label,effect:"plain",size:"small",onClick:Ns=>e.applyTemplate(k.content)},{default:a(()=>[$(_(k.label),1)]),_:2},1032,["onClick"]))),128))])):T("",!0)]),s(c,{class:"mt-12",type:"info",closable:!1,title:"系统会自动抽取症状实体，医生可在下方结构化列表中二次校对"})]),_:1}),s(v,{label:"语音转写",name:"voice"},{default:a(()=>[n("div",Ue,[n("div",Pe,[s(d,{class:B(["mic-btn",{recording:e.isRecording}]),icon:e.Microphone,onClick:e.toggleRecording},{default:a(()=>[$(_(e.isRecording?"停止录音":"开始录音"),1)]),_:1},8,["class","icon","onClick"]),e.isRecording?(o(),r("span",Fe,[t[4]||(t[4]=n("i",{class:"record-dot"},null,-1)),$(" 录音中 "+_(e.recordDuration),1)])):e.uploading?(o(),r("span",Re,[s(g,null,{default:a(()=>[s(y)]),_:1}),t[5]||(t[5]=$(" 正在识别，请稍候… ",-1))])):T("",!0)]),e.recordedUrl?(o(),r("audio",{key:0,src:e.recordedUrl,controls:"",class:"audio-preview"},null,8,Ie)):T("",!0),s(m,{type:"textarea",autosize:{minRows:4,maxRows:10},modelValue:e.voiceTranscription,"onUpdate:modelValue":t[1]||(t[1]=k=>e.voiceTranscription=k),placeholder:"语音转写内容将在此显示，可手动修订"},null,8,["modelValue"])])]),_:1}),s(v,{label:"病例文档",name:"document"},{default:a(()=>[n("div",ze,[s(R,{drag:"",action:"#","show-file-list":!1,"auto-upload":!1,onChange:e.simulateDocParse},{tip:a(()=>[...t[6]||(t[6]=[n("div",{class:"el-upload__tip"},"演示态：上传将注入示例症状列表。",-1)])]),default:a(()=>[s(g,null,{default:a(()=>[s(M)]),_:1}),t[7]||(t[7]=n("div",{class:"el-upload__text"},"拖拽文件或点击上传（支持 PDF / Word / 图片）",-1))]),_:1},8,["onChange"]),e.docExtraction.length?(o(),S(E,{key:0,class:"mt-12"},{default:a(()=>[(o(!0),r(V,null,D(e.docExtraction,k=>(o(),S(C,{key:k.time,timestamp:k.time,placement:"top"},{default:a(()=>[s(F,{shadow:"never"},{default:a(()=>[n("h4",null,_(k.title),1),n("p",null,_(k.content),1)]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})):T("",!0)])]),_:1})]),_:1},8,["modelValue"]),n("div",Ee,[s(d,{type:"primary",icon:e.MagicStick,onClick:e.emitExtraction},{default:a(()=>[...t[8]||(t[8]=[$("抽取症状",-1)])]),_:1},8,["icon","onClick"]),s(d,{icon:e.Refresh,onClick:e.resetInputs},{default:a(()=>[...t[9]||(t[9]=[$("重置",-1)])]),_:1},8,["icon","onClick"])])])}const Le=U(Ce,[["render",Ae],["__scopeId","data-v-7f662f77"]]),Ne=P({name:"ExtractedSymptoms",components:{Delete:J,QuestionFilled:X},props:{symptoms:{type:Array,default:()=>[]}},data(){return{editableSymptoms:[]}},watch:{symptoms:{handler(e){this.editableSymptoms=e.map(t=>({...t}))},immediate:!0,deep:!0},editableSymptoms:{handler(e){this.$emit("update",e.map(t=>({...t})))},deep:!0}},methods:{removeSymptom(e){this.editableSymptoms.splice(e,1)}}}),je={class:"extracted-symptoms"},Oe={class:"header"},Be={class:"weight-cell"};function Ge(e,t,i,p,u,h){const m=l("QuestionFilled"),f=l("el-icon"),c=l("el-tooltip"),v=l("el-input"),d=l("el-table-column"),y=l("el-option"),g=l("el-select"),M=l("el-slider"),R=l("el-switch"),F=l("el-button"),C=l("el-table"),E=l("el-empty");return o(),r("div",je,[n("div",Oe,[t[0]||(t[0]=n("h3",null,"已抽取症状",-1)),s(c,{content:"医生可在此确认和加权症状，阴性症状请切换状态",placement:"top"},{default:a(()=>[s(f,null,{default:a(()=>[s(m)]),_:1})]),_:1})]),e.editableSymptoms.length?(o(),S(C,{key:0,data:e.editableSymptoms,size:"small",border:"",height:"260",class:"symptom-table"},{default:a(()=>[s(d,{label:"症状","min-width":"150"},{default:a(({row:w})=>[s(v,{modelValue:w.label,"onUpdate:modelValue":k=>w.label=k,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),s(d,{label:"严重度",width:"120"},{default:a(({row:w})=>[s(g,{modelValue:w.severity,"onUpdate:modelValue":k=>w.severity=k,size:"small"},{default:a(()=>[s(y,{label:"轻",value:"轻"}),s(y,{label:"中",value:"中"}),s(y,{label:"重",value:"重"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),s(d,{label:"持续时间",width:"140"},{default:a(({row:w})=>[s(v,{modelValue:w.duration,"onUpdate:modelValue":k=>w.duration=k,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),s(d,{label:"部位",width:"120"},{default:a(({row:w})=>[s(v,{modelValue:w.side,"onUpdate:modelValue":k=>w.side=k,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),s(d,{label:"权重",width:"160"},{default:a(({row:w})=>[n("div",Be,[s(M,{modelValue:w.weight,"onUpdate:modelValue":k=>w.weight=k,min:0,max:1,step:.1,"show-input":""},null,8,["modelValue","onUpdate:modelValue"])])]),_:1}),s(d,{label:"阴性",width:"80",align:"center"},{default:a(({row:w})=>[s(R,{modelValue:w.negated,"onUpdate:modelValue":k=>w.negated=k,"active-text":"是","inactive-text":"否"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),s(d,{width:"60",align:"center"},{default:a(({$index:w})=>[s(F,{icon:e.Delete,size:"small",link:"",onClick:k=>e.removeSymptom(w)},null,8,["icon","onClick"])]),_:1})]),_:1},8,["data"])):(o(),S(E,{key:1,description:"等待抽取或导入症状","image-size":120}))])}const He=U(Ne,[["render",Ge],["__scopeId","data-v-befa0d13"]]),Ke=P({name:"AnalysisControlBar",components:{Cpu:ee,DocumentAdd:x,RefreshLeft:Z},props:{params:{type:Object,default:()=>({})}},data(){return{localParams:{...this.params}}},watch:{params:{handler(e){this.localParams={...e}},deep:!0},localParams:{handler(e){Object.keys(e).forEach(t=>{this.$emit("update:param",t,e[t])})},deep:!0}},methods:{emitAnalyze(){this.$emit("analyze")},emitReset(){this.$emit("reset")}}}),We={class:"analysis-control-bar"},Ye={class:"actions"};function qe(e,t,i,p,u,h){const m=l("el-slider"),f=l("el-form-item"),c=l("el-col"),v=l("el-row"),d=l("el-input-number"),y=l("el-option"),g=l("el-select"),M=l("el-input"),R=l("el-form"),F=l("el-button");return o(),r("div",We,[s(R,{model:e.localParams,size:"small","label-position":"top","label-width":"120px",class:"control-form"},{default:a(()=>[s(v,{gutter:8},{default:a(()=>[s(c,{span:12},{default:a(()=>[s(f,{label:"融合系数 α (图谱 vs LLM)"},{default:a(()=>[s(m,{modelValue:e.localParams.alpha,"onUpdate:modelValue":t[0]||(t[0]=C=>e.localParams.alpha=C),min:0,max:1,step:.05,"show-input":""},null,8,["modelValue"])]),_:1})]),_:1}),s(c,{span:12},{default:a(()=>[s(f,{label:"边权阈值"},{default:a(()=>[s(m,{modelValue:e.localParams.threshold,"onUpdate:modelValue":t[1]||(t[1]=C=>e.localParams.threshold=C),min:0,max:1,step:.05,"show-input":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),s(v,{gutter:8},{default:a(()=>[s(c,{span:8},{default:a(()=>[s(f,{label:"Top-N 候选数"},{default:a(()=>[s(d,{modelValue:e.localParams.topN,"onUpdate:modelValue":t[2]||(t[2]=C=>e.localParams.topN=C),min:3,max:10},null,8,["modelValue"])]),_:1})]),_:1}),s(c,{span:8},{default:a(()=>[s(f,{label:"年龄"},{default:a(()=>[s(d,{modelValue:e.localParams.age,"onUpdate:modelValue":t[3]||(t[3]=C=>e.localParams.age=C),min:0,max:120},null,8,["modelValue"])]),_:1})]),_:1}),s(c,{span:8},{default:a(()=>[s(f,{label:"性别"},{default:a(()=>[s(g,{modelValue:e.localParams.gender,"onUpdate:modelValue":t[4]||(t[4]=C=>e.localParams.gender=C)},{default:a(()=>[s(y,{label:"女",value:"F"}),s(y,{label:"男",value:"M"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),s(v,{gutter:8},{default:a(()=>[s(c,{span:12},{default:a(()=>[s(f,{label:"起病时间"},{default:a(()=>[s(M,{modelValue:e.localParams.onset,"onUpdate:modelValue":t[5]||(t[5]=C=>e.localParams.onset=C),placeholder:"如：48h 内"},null,8,["modelValue"])]),_:1})]),_:1}),s(c,{span:12},{default:a(()=>[s(f,{label:"诱发因素"},{default:a(()=>[s(M,{modelValue:e.localParams.trigger,"onUpdate:modelValue":t[6]||(t[6]=C=>e.localParams.trigger=C),placeholder:"如：睡眠不足、情绪波动"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"]),n("div",Ye,[s(F,{type:"primary",icon:e.Cpu,onClick:e.emitAnalyze},{default:a(()=>[...t[8]||(t[8]=[$("开始分析",-1)])]),_:1},8,["icon","onClick"]),s(F,{icon:e.DocumentAdd,onClick:t[7]||(t[7]=C=>e.$emit("save-snapshot"))},{default:a(()=>[...t[9]||(t[9]=[$("保存快照",-1)])]),_:1},8,["icon"]),s(F,{icon:e.RefreshLeft,onClick:e.emitReset},{default:a(()=>[...t[10]||(t[10]=[$("恢复默认",-1)])]),_:1},8,["icon","onClick"])])])}const Qe=U(Ke,[["render",qe],["__scopeId","data-v-6c2c586a"]]),Xe=P({name:"SymptomIntakeModule",components:{SymptomInputPanel:Le,ExtractedSymptoms:He,AnalysisControlBar:Qe,Setting:O},props:{templates:{type:Array,default:()=>[]},symptoms:{type:Array,default:()=>[]},params:{type:Object,default:()=>({})}},methods:{emitExtracted(e){this.$emit("symptoms-extracted",e)},emitUpdated(e){this.$emit("symptoms-update",e)},emitParamUpdate(e,t){this.$emit("param-update",e,t)},emitAnalyze(){this.$emit("analyze")},emitReset(){this.$emit("reset")},emitSnapshot(){this.$emit("save-snapshot")}}}),Je={class:"module-intake"},Ze={class:"card-header"},xe={class:"card-header"},et={class:"card-header"};function tt(e,t,i,p,u,h){const m=l("el-tag"),f=l("SymptomInputPanel"),c=l("el-card"),v=l("el-col"),d=l("el-row"),y=l("ExtractedSymptoms"),g=l("Setting"),M=l("el-icon"),R=l("el-tooltip"),F=l("AnalysisControlBar");return o(),r("div",Je,[s(d,{gutter:24,class:"row-section"},{default:a(()=>[s(v,{xs:24,lg:24},{default:a(()=>[s(c,{class:"module-card input-card",shadow:"never"},{header:a(()=>[n("div",Ze,[t[1]||(t[1]=n("div",null,[n("span",{class:"title"},"症状采集与标准化"),n("p",{class:"subtitle"},"支持文本、语音转写与病例文档快速录入")],-1)),s(m,{size:"small",type:"info",effect:"dark"},{default:a(()=>[...t[0]||(t[0]=[$("多模态",-1)])]),_:1})])]),default:a(()=>[s(f,{templates:e.templates,onSymptomsExtracted:e.emitExtracted},null,8,["templates","onSymptomsExtracted"])]),_:1})]),_:1})]),_:1}),s(d,{gutter:24,class:"row-section"},{default:a(()=>[s(v,{xs:24,lg:24},{default:a(()=>[s(c,{class:"module-card structured-card",shadow:"never"},{header:a(()=>[n("div",xe,[t[3]||(t[3]=n("span",{class:"title"},"结构化症状清单",-1)),s(m,{size:"small",type:"warning",effect:"plain"},{default:a(()=>[...t[2]||(t[2]=[$("需医生确认",-1)])]),_:1})])]),default:a(()=>[s(y,{symptoms:e.symptoms,onUpdate:e.emitUpdated},null,8,["symptoms","onUpdate"])]),_:1})]),_:1})]),_:1}),s(d,{gutter:24,class:"row-section"},{default:a(()=>[s(v,{xs:24,lg:24},{default:a(()=>[s(c,{class:"module-card control-card",shadow:"never"},{header:a(()=>[n("div",et,[t[4]||(t[4]=n("span",{class:"title"},"联合分析参数",-1)),s(R,{content:"调整图谱与大模型权重、候选数量等参数",placement:"top"},{default:a(()=>[s(M,null,{default:a(()=>[s(g)]),_:1})]),_:1})])]),default:a(()=>[s(F,{params:e.params,"onUpdate:param":e.emitParamUpdate,onAnalyze:e.emitAnalyze,onReset:e.emitReset,onSaveSnapshot:e.emitSnapshot},null,8,["params","onUpdate:param","onAnalyze","onReset","onSaveSnapshot"])]),_:1})]),_:1})]),_:1})])}const st=U(Xe,[["render",tt],["__scopeId","data-v-49fee04e"]]),z={symptom:"#409EFF",disease:"#F56C6C",test:"#E6A23C",sign:"#9B59B6"},at=P({name:"GraphView",props:{graphData:{type:Object,default:()=>({nodes:[],edges:[]})},filters:{type:Object,default:()=>({nodeTypes:[],threshold:.3})}},data(){return{localFilters:{...this.filters}}},computed:{viewBox(){return"0 0 800 480"},legendItems(){return[{type:"symptom",label:"症状",color:z.symptom},{type:"disease",label:"疾病",color:z.disease},{type:"test",label:"检查/检验",color:z.test}]},filteredNodes(){return this.graphData.nodes.filter(e=>this.localFilters.nodeTypes.includes(e.type))},nodePositions(){const e={},t=this.groupNodesByType(this.filteredNodes),i={symptom:160,disease:400,test:640,sign:520};return Object.keys(t).forEach(p=>{const u=t[p],h=360/(u.length+1);u.forEach((m,f)=>{e[m.id]={x:i[p]||400,y:60+h*(f+1)}})}),e},visibleEdges(){return this.graphData.edges.filter(e=>{const t=this.graphData.nodes.find(h=>h.id===e.source),i=this.graphData.nodes.find(h=>h.id===e.target);if(!t||!i)return!1;const p=this.localFilters.nodeTypes.includes(t.type),u=this.localFilters.nodeTypes.includes(i.type);return p&&u&&e.weight>=this.localFilters.threshold})},visibleNodes(){const e=new Set;return this.visibleEdges.forEach(t=>{e.add(t.source),e.add(t.target)}),this.filteredNodes.filter(t=>e.has(t.id))}},watch:{filters:{handler(e){this.localFilters={...e}},deep:!0},localFilters:{handler(){this.emitFilters()},deep:!0}},methods:{groupNodesByType(e){return e.reduce((t,i)=>(t[i.type]||(t[i.type]=[]),t[i.type].push(i),t),{})},nodeColor(e){return z[e.type]||"#909399"},edgeColor(e){const t=this.graphData.nodes.find(i=>i.id===e.target);return t?this.nodeColor(t):"#C0C4CC"},radius(e){return 18+(e.value||.3)*8},handleNodeClick(e){this.$emit("node-select",e)},emitFilters(){this.$emit("filters-change",{...this.localFilters})}}}),nt={class:"graph-view"},lt={class:"graph-controls"},ot={class:"control-row"},it={class:"control-row"},rt={class:"graph-canvas"},dt=["viewBox"],ct={class:"edges"},ut=["x1","y1","x2","y2","stroke-width","stroke"],pt={class:"nodes"},mt=["transform","onClick"],ht=["r","fill"],ft={class:"label",dy:"4",x:"0"},gt={class:"legend"};function _t(e,t,i,p,u,h){const m=l("el-checkbox"),f=l("el-checkbox-group"),c=l("el-slider"),v=l("el-empty");return o(),r("div",nt,[n("div",lt,[n("div",ot,[t[5]||(t[5]=n("span",{class:"label"},"节点类型",-1)),s(f,{modelValue:e.localFilters.nodeTypes,"onUpdate:modelValue":t[0]||(t[0]=d=>e.localFilters.nodeTypes=d),size:"small"},{default:a(()=>[s(m,{label:"symptom"},{default:a(()=>[...t[2]||(t[2]=[$("症状",-1)])]),_:1}),s(m,{label:"disease"},{default:a(()=>[...t[3]||(t[3]=[$("疾病",-1)])]),_:1}),s(m,{label:"test"},{default:a(()=>[...t[4]||(t[4]=[$("检查",-1)])]),_:1})]),_:1},8,["modelValue"])]),n("div",it,[t[6]||(t[6]=n("span",{class:"label"},"边权阈值",-1)),s(c,{modelValue:e.localFilters.threshold,"onUpdate:modelValue":t[1]||(t[1]=d=>e.localFilters.threshold=d),min:0,max:1,step:.05,"show-input":"",onChange:e.emitFilters},null,8,["modelValue","onChange"])])]),n("div",rt,[(o(),r("svg",{viewBox:e.viewBox,preserveAspectRatio:"xMidYMid meet"},[t[7]||(t[7]=n("defs",null,[n("marker",{id:"arrow",markerWidth:"6",markerHeight:"6",refX:"6",refY:"3",orient:"auto"},[n("path",{d:"M0,0 L6,3 L0,6 Z",fill:"#c0c4cc"})])],-1)),n("g",ct,[(o(!0),r(V,null,D(e.visibleEdges,d=>(o(),r("line",{key:d.source+"-"+d.target,x1:e.nodePositions[d.source].x,y1:e.nodePositions[d.source].y,x2:e.nodePositions[d.target].x,y2:e.nodePositions[d.target].y,"stroke-width":Math.max(1.5,d.weight*6),stroke:e.edgeColor(d),"marker-end":"url(#arrow)","stroke-linecap":"round",opacity:"0.7"},null,8,ut))),128))]),n("g",pt,[(o(!0),r(V,null,D(e.visibleNodes,d=>(o(),r("g",{key:d.id,class:"node",transform:`translate(${e.nodePositions[d.id].x}, ${e.nodePositions[d.id].y})`,onClick:y=>e.handleNodeClick(d)},[n("circle",{r:e.radius(d),fill:e.nodeColor(d)},null,8,ht),n("text",ft,_(d.label),1)],8,mt))),128))])],8,dt)),e.visibleNodes.length?T("",!0):(o(),S(v,{key:0,description:"无可显示节点"}))]),n("div",gt,[(o(!0),r(V,null,D(e.legendItems,d=>(o(),r("div",{class:"legend-item",key:d.type},[n("span",{class:"dot",style:te({backgroundColor:d.color})},null,4),n("span",null,_(d.label),1)]))),128))])])}const yt=U(at,[["render",_t],["__scopeId","data-v-20f2513b"]]),vt=P({name:"AnalysisTimeline",props:{steps:{type:Array,default:()=>[]},status:{type:String,default:"idle"}},computed:{activeIndex(){const e=this.steps.findIndex(t=>t.status==="current");return e!==-1?e:this.status==="done"?this.steps.length:0}},methods:{statusMap(e){switch(e){case"done":return"success";case"error":return"error";case"current":return"process";default:return"wait"}},formatDescription(e,t){return e.status==="done"?`耗时 ${e.duration||"--"}`:e.status==="current"?"执行中":e.status==="error"?e.error||"失败":t===0?"待开始":""}}}),bt={class:"analysis-timeline"};function $t(e,t,i,p,u,h){const m=l("el-step"),f=l("el-steps");return o(),r("div",bt,[s(f,{active:e.activeIndex,"finish-status":"success","align-center":""},{default:a(()=>[(o(!0),r(V,null,D(e.steps,(c,v)=>(o(),S(m,{key:c.key,title:c.title,description:e.formatDescription(c,v),status:e.statusMap(c.status)},null,8,["title","description","status"]))),128))]),_:1},8,["active"])])}const kt=U(vt,[["render",$t],["__scopeId","data-v-85b75da5"]]),wt=P({name:"SymptomNetworkModule",components:{GraphView:yt,AnalysisTimeline:kt},props:{graphData:{type:Object,default:()=>({nodes:[],edges:[]})},graphFilters:{type:Object,default:()=>({nodeTypes:[],threshold:.3})},analysisTimeline:{type:Array,default:()=>[]},analysisStatus:{type:String,default:"idle"}},computed:{nodeCount(){return this.graphData.nodes.length},edgeCount(){return this.graphData.edges.length},nodeTypeText(){if(!this.graphFilters.nodeTypes||!this.graphFilters.nodeTypes.length)return"全部";const e={symptom:"症状",disease:"疾病",test:"检查"};return this.graphFilters.nodeTypes.map(t=>e[t]||t).join(" / ")},statusText(){switch(this.analysisStatus){case"processing":return"正在分析";case"done":return"分析完成";case"error":return"分析失败";default:return"待开始"}},statusTagType(){switch(this.analysisStatus){case"processing":return"warning";case"done":return"success";case"error":return"danger";default:return"info"}}},methods:{emitFilters(e){this.$emit("filters-change",e)}}}),St={class:"module-network"},Tt={class:"card-header"},Ct={class:"card-header"},Vt={class:"insight-list"},Dt={class:"insight-item"},Mt={class:"value"},Ut={class:"insight-item"},Pt={class:"value"},Ft={class:"insight-item"},Rt={class:"value"},It={class:"insight-item"},zt={class:"value"};function Et(e,t,i,p,u,h){const m=l("el-tag"),f=l("GraphView"),c=l("el-card"),v=l("el-col"),d=l("AnalysisTimeline"),y=l("el-row");return o(),r("div",St,[s(y,{gutter:24},{default:a(()=>[s(v,{xs:24,lg:16},{default:a(()=>[s(c,{class:"module-card graph-card",shadow:"never"},{header:a(()=>[n("div",Tt,[t[1]||(t[1]=n("div",null,[n("span",{class:"title"},"症状-疾病关系图"),n("p",{class:"subtitle"},"基于 Neo4j 子图的实时证据网络，可筛选节点类型和边权")],-1)),s(m,{size:"small",type:"success",effect:"dark"},{default:a(()=>[...t[0]||(t[0]=[$("互动",-1)])]),_:1})])]),default:a(()=>[s(f,{"graph-data":e.graphData,filters:e.graphFilters,onFiltersChange:e.emitFilters},null,8,["graph-data","filters","onFiltersChange"])]),_:1})]),_:1}),s(v,{xs:24,lg:8},{default:a(()=>[s(c,{class:"module-card timeline-card",shadow:"never"},{header:a(()=>[n("div",Ct,[t[2]||(t[2]=n("span",{class:"title"},"分析进度",-1)),s(m,{size:"small",type:e.statusTagType},{default:a(()=>[$(_(e.statusText),1)]),_:1},8,["type"])])]),default:a(()=>[s(d,{steps:e.analysisTimeline,status:e.analysisStatus},null,8,["steps","status"])]),_:1}),s(c,{class:"module-card insight-card",shadow:"never"},{header:a(()=>[...t[3]||(t[3]=[n("div",{class:"card-header"},[n("span",{class:"title"},"数据概览")],-1)])]),default:a(()=>[n("div",Vt,[n("div",Dt,[t[4]||(t[4]=n("span",{class:"label"},"节点数量",-1)),n("span",Mt,_(e.nodeCount),1)]),n("div",Ut,[t[5]||(t[5]=n("span",{class:"label"},"边数量",-1)),n("span",Pt,_(e.edgeCount),1)]),n("div",Ft,[t[6]||(t[6]=n("span",{class:"label"},"阈值过滤",-1)),n("span",Rt,"≥ "+_((e.graphFilters.threshold*100).toFixed(0))+"%",1)]),n("div",It,[t[7]||(t[7]=n("span",{class:"label"},"展示类型",-1)),n("span",zt,_(e.nodeTypeText),1)])])]),_:1})]),_:1})]),_:1})])}const At=U(wt,[["render",Et],["__scopeId","data-v-94620d9a"]]),Lt=P({name:"DiagnosisCandidates",props:{candidates:{type:Array,default:()=>[]},selected:{type:String,default:""}},data(){return{localSelected:this.selected}},watch:{selected(e){this.localSelected=e}},methods:{emitSelect(e){this.$emit("select",e)},progressColor(e){return e>=.75?"#67C23A":e>=.5?"#E6A23C":"#F56C6C"}}}),Nt={class:"diagnosis-candidates"},jt={class:"score-row"},Ot={class:"score-label"},Bt={class:"meta"},Gt={key:0,class:"missing-list"},Ht={key:1,class:"guideline"};function Kt(e,t,i,p,u,h){const m=l("el-radio"),f=l("el-progress"),c=l("el-tag"),v=l("el-card"),d=l("el-radio-group"),y=l("el-alert");return o(),r("div",Nt,[s(d,{modelValue:e.localSelected,"onUpdate:modelValue":t[0]||(t[0]=g=>e.localSelected=g),class:"candidate-list",onChange:e.emitSelect},{default:a(()=>[(o(!0),r(V,null,D(e.candidates,g=>(o(),S(v,{key:g.code,shadow:"hover",class:B(["candidate-card",{active:g.code===e.localSelected}])},{default:a(()=>[s(m,{label:g.code,class:"title"},{default:a(()=>[$(_(g.name),1)]),_:2},1032,["label"]),n("div",jt,[s(f,{percentage:Math.round(g.score*100),"stroke-width":10,color:e.progressColor(g.score)},null,8,["percentage","color"]),n("span",Ot,"置信度 "+_((g.score*100).toFixed(0))+"%",1)]),n("div",Bt,[s(c,{size:"small",type:"info"},{default:a(()=>[$("证据 "+_(g.evidenceCount),1)]),_:2},1024),g.missingKey&&g.missingKey.length?(o(),S(c,{key:0,size:"small",type:"warning"},{default:a(()=>[$(" 缺失 "+_(g.missingKey.length)+" 项 ",1)]),_:2},1024)):T("",!0)]),g.missingKey&&g.missingKey.length?(o(),r("ul",Gt,[(o(!0),r(V,null,D(g.missingKey,M=>(o(),r("li",{key:M},_(M),1))),128))])):T("",!0),g.guidelines&&g.guidelines.length?(o(),r("div",Ht,[t[1]||(t[1]=n("span",null,"参考指南：",-1)),n("ul",null,[(o(!0),r(V,null,D(g.guidelines,M=>(o(),r("li",{key:M},_(M),1))),128))])])):T("",!0)]),_:2},1032,["class"]))),128))]),_:1},8,["modelValue","onChange"]),e.candidates.length?T("",!0):(o(),S(y,{key:0,title:"暂无候选诊断，请先完成症状抽取和分析。",type:"info",closable:!1}))])}const Wt=U(Lt,[["render",Kt],["__scopeId","data-v-f81cb0e9"]]),Yt=P({name:"EvidencePanel",components:{Link:se},props:{disease:{type:String,default:""},evidence:{type:Object,default:null}}}),qt={class:"evidence-panel"},Qt={key:0,class:"content"},Xt={key:0,class:"contrib-bars"},Jt={class:"label"},Zt={class:"matched-list"},xt={key:1},es={key:2,class:"negatives"},ts={key:3},ss={key:4,class:"references"},as=["href"];function ns(e,t,i,p,u,h){const m=l("el-progress"),f=l("el-tag"),c=l("Link"),v=l("el-icon"),d=l("el-empty");return o(),r("div",qt,[e.disease&&e.evidence?(o(),r("div",Qt,[t[0]||(t[0]=n("h3",null,"证据贡献",-1)),e.evidence.contrib&&e.evidence.contrib.length?(o(),r("div",Xt,[(o(!0),r(V,null,D(e.evidence.contrib,y=>(o(),r("div",{key:y.label,class:"bar-item"},[n("span",Jt,_(y.label),1),s(m,{percentage:Math.round(y.value*100),"stroke-width":10},null,8,["percentage"])]))),128))])):T("",!0),t[1]||(t[1]=n("h4",null,"匹配症状",-1)),n("ul",Zt,[(o(!0),r(V,null,D(e.evidence.matched,y=>(o(),r("li",{key:y.label},[n("span",null,_(y.label),1),s(f,{type:"success",size:"small"},{default:a(()=>[$("权重 "+_((y.weight*100).toFixed(0))+"%",1)]),_:2},1024)]))),128))]),e.evidence.negatives&&e.evidence.negatives.length?(o(),r("h4",xt,"阴性证据")):T("",!0),e.evidence.negatives&&e.evidence.negatives.length?(o(),r("ul",es,[(o(!0),r(V,null,D(e.evidence.negatives,y=>(o(),r("li",{key:y},_(y),1))),128))])):T("",!0),e.evidence.references&&e.evidence.references.length?(o(),r("h4",ts,"参考来源")):T("",!0),e.evidence.references&&e.evidence.references.length?(o(),r("ul",ss,[(o(!0),r(V,null,D(e.evidence.references,y=>(o(),r("li",{key:y.title},[s(v,null,{default:a(()=>[s(c)]),_:1}),n("a",{href:y.url,target:"_blank",rel:"noopener noreferrer"},_(y.title),9,as)]))),128))])):T("",!0)])):(o(),S(d,{key:1,description:"请选择候选诊断查看详细证据"}))])}const ls=U(Yt,[["render",ns],["__scopeId","data-v-7eb8fbcc"]]),os=P({name:"SymptomInsightModule",components:{DiagnosisCandidates:Wt,EvidencePanel:ls},props:{candidates:{type:Array,default:()=>[]},selected:{type:String,default:""},evidenceMap:{type:Object,default:()=>({})}},computed:{evidence(){return this.evidenceMap[this.selected]},selectedName(){const e=this.candidates.find(t=>t.code===this.selected);return e?e.name:""}},methods:{emitSelect(e){this.$emit("select",e)}}}),is={class:"module-insight"},rs={class:"card-header"},ds={class:"card-header"};function cs(e,t,i,p,u,h){const m=l("el-tag"),f=l("DiagnosisCandidates"),c=l("el-card"),v=l("el-col"),d=l("EvidencePanel"),y=l("el-row");return o(),r("div",is,[s(y,{gutter:24},{default:a(()=>[s(v,{xs:24,lg:10},{default:a(()=>[s(c,{class:"module-card candidates-card",shadow:"never"},{header:a(()=>[n("div",rs,[t[1]||(t[1]=n("div",null,[n("span",{class:"title"},"候选诊断"),n("p",{class:"subtitle"},"Top-N 疾病候选，按置信度排序，可勾选对比")],-1)),s(m,{size:"small",type:"primary",effect:"dark"},{default:a(()=>[...t[0]||(t[0]=[$("LLM+图谱",-1)])]),_:1})])]),default:a(()=>[s(f,{candidates:e.candidates,selected:e.selected,onSelect:e.emitSelect},null,8,["candidates","selected","onSelect"])]),_:1})]),_:1}),s(v,{xs:24,lg:14},{default:a(()=>[s(c,{class:"module-card evidence-card",shadow:"never"},{header:a(()=>[n("div",ds,[t[2]||(t[2]=n("div",null,[n("span",{class:"title"},"证据解读"),n("p",{class:"subtitle"},"展示贡献度、匹配症状、阴性证据与参考来源")],-1)),e.selectedName?(o(),S(m,{key:0,size:"small",type:"success",effect:"dark"},{default:a(()=>[$(_(e.selectedName),1)]),_:1})):T("",!0)])]),default:a(()=>[s(d,{disease:e.selected,evidence:e.evidence},null,8,["disease","evidence"])]),_:1})]),_:1})]),_:1})])}const us=U(os,[["render",cs],["__scopeId","data-v-e6eb67cd"]]),ps=P({name:"FullGraphModule",data(){return{API_BASE:"http://localhost:5000/api",loading:!1,error:null,Graph:null}},mounted(){this.initializeVisualization()},methods:{async initializeVisualization(){await this.loadD3Scripts(),this.initGraph(),await this.loadFullGraph()},loadD3Scripts(){return new Promise(e=>{if(window.d3){this.loadForceGraphScript(e);return}const t=document.createElement("script");t.src="https://d3js.org/d3.v7.min.js",t.onload=()=>{this.loadForceGraphScript(e)},document.head.appendChild(t)})},loadForceGraphScript(e){if(window.ForceGraph){e();return}const t=document.createElement("script");t.src="https://unpkg.com/force-graph",t.onload=()=>e(),document.head.appendChild(t)},showError(e){this.error=e,setTimeout(()=>{this.error=null},5e3)},setLoading(e){this.loading=e},initGraph(){if(!this.$refs.graph||!window.ForceGraph)return;const e=this.$refs.graph;this.Graph=window.ForceGraph()(e).nodeId("id").nodeLabel("name").nodeVal("value").nodeAutoColorBy("type").nodeCanvasObject((t,i,p)=>{const u=t.name,h=Math.max(1,.5/p);i.font=`${h}px Sans-Serif`;const f=[i.measureText(u).width,h].map(d=>d+h*.2);let c;switch(t.type){case"症状":c="#e74c3c";break;case"疾病":c="#3498db";break;case"治疗方法":c="#f39c12";break;case"药物":c="#9b59b6";break;default:c="#95a5a6"}const v=Math.max(5,5/p);i.fillStyle=c,i.beginPath(),i.arc(t.x,t.y,v,0,2*Math.PI,!1),i.fill(),i.fillStyle="rgba(255, 255, 255, 0.8)",i.fillRect(t.x-f[0]/2,t.y-f[1]/2,...f),i.textAlign="center",i.textBaseline="middle",i.fillStyle="#000",i.fillText(u,t.x,t.y)}).linkLabel("relationship").linkDirectionalParticles(2).linkDirectionalParticleSpeed(.005).onNodeClick((t,i)=>{this.showNodeInfo(t,i)}).onBackgroundClick(()=>{this.$refs.nodeInfo&&(this.$refs.nodeInfo.style.display="none")}),this.Graph.graphData({nodes:[],links:[]})},showNodeInfo(e,t){const i=this.$refs.nodeInfo;if(!i)return;let p=`<h3>${e.name}</h3><p>类型: ${e.type}</p>`;if(e.properties){p+="<p>属性:</p><ul>";for(const[u,h]of Object.entries(e.properties))["id","labels","elementId"].includes(u)||(p+=`<li>${u}: ${h}</li>`);p+="</ul>"}i.innerHTML=p,i.style.display="block",i.style.left=`${t.pageX+10}px`,i.style.top=`${t.pageY+10}px`},async loadFullGraph(){try{this.setLoading(!0);const e=await fetch(`${this.API_BASE}/graph/all`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();t.nodes&&t.links&&this.Graph&&this.Graph.graphData(t)}catch(e){console.error("获取全图失败:",e),this.showError(`加载全图失败: ${e.message}`)}finally{this.setLoading(!1)}}}}),ms={class:"medical-knowledge-graph"},hs={key:0,class:"error",id:"errorMessage"},fs={key:1,class:"loading",id:"loadingIndicator"},gs={class:"visualization"},_s={ref:"graph",id:"graph"},ys={ref:"nodeInfo",class:"node-info",style:{display:"none"}};function vs(e,t,i,p,u,h){return o(),r("div",ms,[t[2]||(t[2]=n("header",null,[n("h1",null,"医学知识图谱推理演示")],-1)),e.error?(o(),r("div",hs,_(e.error),1)):T("",!0),e.loading?(o(),r("div",fs,[...t[0]||(t[0]=[n("p",null,"正在查询知识图谱，请稍候...",-1)])])):T("",!0),n("div",gs,[n("div",_s,null,512),t[1]||(t[1]=ae('<div class="legend" data-v-b6f653de><div class="legend-item" data-v-b6f653de><div class="legend-color" style="background-color:#e74c3c;" data-v-b6f653de></div><span data-v-b6f653de>症状</span></div><div class="legend-item" data-v-b6f653de><div class="legend-color" style="background-color:#3498db;" data-v-b6f653de></div><span data-v-b6f653de>疾病</span></div><div class="legend-item" data-v-b6f653de><div class="legend-color" style="background-color:#f39c12;" data-v-b6f653de></div><span data-v-b6f653de>治疗方法</span></div><div class="legend-item" data-v-b6f653de><div class="legend-color" style="background-color:#9b59b6;" data-v-b6f653de></div><span data-v-b6f653de>药物</span></div></div>',1))]),n("div",ys,null,512)])}const bs=U(ps,[["render",vs],["__scopeId","data-v-b6f653de"]]),N=()=>[{key:"preprocess",title:"预处理",status:"wait",duration:"≈0.8s"},{key:"graph",title:"图谱检索",status:"wait",duration:"≈1.2s"},{key:"fusion",title:"融合打分",status:"wait",duration:"≈1.0s"}],$s=P({name:"SymptomAnalysisView",components:{PatientHeader:ke,SideToolbar:Te,IntakeModule:st,NetworkModule:At,InsightModule:us,FullGraphModule:bs},data(){return{activeModule:"intake",moduleMenu:[{key:"intake",label:"症状录入",desc:"多模态采集与标准化",icon:de},{key:"network",label:"关联图谱",desc:"Neo4j 证据网络",icon:ce},{key:"insight",label:"诊断洞察",desc:"候选排序与证据",icon:ue},{key:"fullgraph",label:"完整图谱",desc:"全部知识图谱可视化",icon:pe}],patient:{name:"张某某",age:46,gender:"女",visitType:"门诊复诊",visitTime:"2025-09-25 09:30",visitId:"M-20250925-001",allergies:["青霉素"],alerts:["高血压史","偏头痛家族史"]},inputTemplates:[{label:"偏头痛模板",content:"持续性搏动性头痛，伴随恶心、畏光，既往偏头痛史。"},{label:"脑供血不足",content:"间断性眩晕，站立时加重，伴随上肢麻木。"}],normalizedSymptoms:[{code:"S-0001",label:"搏动性头痛",severity:"中",duration:"48小时",side:"双侧",weight:.8,negated:!1},{code:"S-0045",label:"恶心伴呕吐",severity:"轻",duration:"24小时",side:"全身",weight:.6,negated:!1},{code:"S-0120",label:"畏光",severity:"轻",duration:"48小时",side:"双眼",weight:.4,negated:!1}],analysisParams:{alpha:.6,threshold:.35,topN:5,age:46,gender:"F",onset:"48h 内",trigger:"情绪波动"},analysisStatus:"idle",analysisTimeline:N(),analysisTimers:[],graphData:{nodes:[{id:"S-0001",label:"搏动性头痛",type:"symptom",value:.8},{id:"S-0045",label:"恶心伴呕吐",type:"symptom",value:.6},{id:"S-0120",label:"畏光",type:"symptom",value:.4},{id:"D-1002",label:"偏头痛",type:"disease",value:.9},{id:"D-1015",label:"脑膜炎",type:"disease",value:.55},{id:"T-901",label:"颅脑 MRI",type:"test",value:.3}],edges:[{source:"S-0001",target:"D-1002",weight:.8},{source:"S-0045",target:"D-1002",weight:.6},{source:"S-0120",target:"D-1002",weight:.5},{source:"S-0001",target:"D-1015",weight:.3},{source:"D-1002",target:"T-901",weight:.4}]},graphFilters:{nodeTypes:["symptom","disease","test"],threshold:.3},diagnosisCandidates:[{code:"D-1002",name:"偏头痛（未伴先兆）",score:.87,evidenceCount:7,missingKey:["神经系统查体"],guidelines:["中华医学会神经病学分会偏头痛诊治指南(2022)"]},{code:"D-1015",name:"病毒性脑膜炎",score:.46,evidenceCount:4,missingKey:["发热","颈抵抗"],guidelines:["IDSA Viral Meningitis Guideline 2021"]},{code:"D-1302",name:"颈源性头痛",score:.31,evidenceCount:3,missingKey:["颈部影像","颈部压痛"],guidelines:[]}],evidenceMap:{"D-1002":{matched:[{label:"搏动性头痛",weight:.8},{label:"恶心伴呕吐",weight:.6},{label:"畏光",weight:.5}],negatives:["无发热","无神经功能缺损"],contrib:[{label:"图谱证据",value:.62},{label:"LLM 综合评分",value:.25},{label:"指南匹配",value:.13}],references:[{title:"2022 偏头痛诊治中国指南",url:"https://example.org/guidelines/migraine-2022"},{title:"UpToDate: Migraine in Adults",url:"https://example.org/references/migraine-uptodate"}]},"D-1015":{matched:[{label:"搏动性头痛",weight:.3}],negatives:["缺少发热","缺少颈抵抗"],contrib:[{label:"图谱证据",value:.28},{label:"LLM 综合评分",value:.18}],references:[]},"D-1302":{matched:[{label:"搏动性头痛",weight:.2}],negatives:["缺少颈部影像","无颈部压痛"],contrib:[{label:"图谱证据",value:.12},{label:"LLM 综合评分",value:.19}],references:[]}},selectedDisease:"D-1002"}},computed:{activeModuleComponent(){return{intake:"IntakeModule",network:"NetworkModule",insight:"InsightModule",fullgraph:"FullGraphModule"}[this.activeModule]||"IntakeModule"},moduleProps(){switch(this.activeModule){case"network":return{graphData:this.graphData,graphFilters:this.graphFilters,analysisTimeline:this.analysisTimeline,analysisStatus:this.analysisStatus};case"insight":return{candidates:this.diagnosisCandidates,selected:this.selectedDisease,evidenceMap:this.evidenceMap};case"fullgraph":return{};default:return{templates:this.inputTemplates,symptoms:this.normalizedSymptoms,params:this.analysisParams}}},moduleListeners(){switch(this.activeModule){case"network":return{"filters-change":this.handleFilterChange};case"insight":return{select:this.handleCandidateSelect};case"fullgraph":return{};default:return{"symptoms-extracted":this.handleSymptomsExtracted,"symptoms-update":this.handleSymptomsUpdate,"param-update":this.handleParamUpdate,analyze:this.startAnalysis,reset:this.resetAnalysis,"save-snapshot":this.handleSaveSnapshot}}},heroStats(){const e=this.diagnosisCandidates[0];return[{label:"已确认症状",value:`${this.normalizedSymptoms.length} 项`,icon:le},{label:"候选诊断",value:`${this.diagnosisCandidates.length} 项`,icon:oe},{label:"当前进度",value:this.analysisStatus==="done"?"分析完成":this.analysisStatus==="processing"?"分析进行中":"待分析",icon:ie},e&&{label:"最高置信度",value:`${Math.round(e.score*100)}%`,icon:re}].filter(Boolean)}},methods:{handleModuleChange(e){this.activeModule=e},async handleExport(){try{const e=`患者${this.patient.name}，${this.patient.gender}，${this.patient.age}岁`,t=this.normalizedSymptoms.map(h=>h.label).join(", ");if(!t){b.warning("请先提取症状关键词");return}const i=this.candidates.slice(0,3).map(h=>h.name).join(", ");b.info("正在生成诊断报告...");const p=await fetch("http://localhost:5000/api/medical/generate_report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_info:e,keywords:t,diseases:i||"待进一步诊断"})}),u=await p.json();p.ok&&u&&u.report?(L.alert(u.report,"诊断报告",{confirmButtonText:"确定",type:"info",customClass:"report-message-box"}),b.success("报告生成成功")):b.error(u?.error||"报告生成失败")}catch(e){console.error(e),b.error("生成报告时出错")}},handleSync(){b.success("示例：写回 EMR 成功")},handleSymptomsExtracted(e){this.normalizedSymptoms=e,this.analysisStatus="idle",this.resetTimeline(),b.success(`示例：已抽取 ${e.length} 条症状`)},handleSymptomsUpdate(e){this.normalizedSymptoms=e},handleParamUpdate(e,t){this.analysisParams={...this.analysisParams,[e]:t}},startAnalysis(){if(!this.normalizedSymptoms.length){b.warning("请先抽取并确认症状信息");return}this.clearAnalysisTimers(),this.analysisStatus="processing",this.analysisTimeline=this.analysisTimeline.map((t,i)=>({...t,status:i===0?"current":"wait"})),b.info("开始联合分析：模拟触发后台流程"),[()=>{this.updateTimelineStatus(0,"done"),this.updateTimelineStatus(1,"current")},()=>{this.updateTimelineStatus(1,"done"),this.updateTimelineStatus(2,"current")},()=>{this.updateTimelineStatus(2,"done"),this.analysisStatus="done",b.success("分析完成（示例数据）")}].forEach((t,i)=>{const p=setTimeout(t,(i+1)*900);this.analysisTimers.push(p)})},resetAnalysis(){this.clearAnalysisTimers(),this.analysisStatus="idle",this.resetTimeline(),b.info("已重置分析参数（示例）")},handleFilterChange(e){this.graphFilters=e},handleCandidateSelect(e){this.selectedDisease=e,this.activeModule="insight"},handleDensityChange(){b.info("布局密度切换仅为示例")},handleOpenShortcuts(){L.alert("示例快捷键：Alt + Shift + A 开始分析，Alt + Shift + S 保存快照。","快捷键 (示例)",{confirmButtonText:"知道了"})},handleSaveSnapshot(){b.success("示例：已保存当前分析快照")},updateTimelineStatus(e,t){this.analysisTimeline=this.analysisTimeline.map((i,p)=>({...i,status:p===e?t:i.status}))},resetTimeline(){this.analysisTimeline=N()},clearAnalysisTimers(){this.analysisTimers.forEach(e=>clearTimeout(e)),this.analysisTimers=[]}},beforeUnmount(){this.clearAnalysisTimers()}}),ks={class:"symptom-analysis-layout"},ws={class:"patient-header-section"},Ss={class:"container"},Ts={class:"stats-container"},Cs={class:"stat-body"},Vs={class:"stat-label"},Ds={class:"stat-value"},Ms={class:"workspace-container"},Us={class:"container"},Ps={class:"workspace-sidebar"},Fs={class:"menu-content"},Rs={class:"menu-label"},Is={class:"menu-desc"},zs={class:"sidebar-footer"},Es={class:"workspace-content"},As={class:"side-toolbar-container"};function Ls(e,t,i,p,u,h){const m=l("PatientHeader"),f=l("el-icon"),c=l("el-menu-item"),v=l("el-menu"),d=l("el-alert"),y=l("SideToolbar");return o(),r("div",ks,[n("header",ws,[n("div",Ss,[s(m,{patient:e.patient,"visit-id":e.patient.visitId,onExport:e.handleExport,onSync:e.handleSync},null,8,["patient","visit-id","onExport","onSync"]),n("div",Ts,[(o(!0),r(V,null,D(e.heroStats,g=>(o(),r("div",{key:g.label,class:"stat-card"},[g.icon?(o(),S(f,{key:0,class:"stat-icon"},{default:a(()=>[(o(),S(A(g.icon)))]),_:2},1024)):T("",!0),n("div",Cs,[n("span",Vs,_(g.label),1),n("span",Ds,_(g.value),1)])]))),128))])])]),n("main",Ms,[n("div",Us,[n("aside",Ps,[t[0]||(t[0]=n("div",{class:"sidebar-header"},[n("span",{class:"sidebar-title"},"分析模块"),n("p",{class:"sidebar-desc"},"根据工作流快速跳转到不同阶段")],-1)),s(v,{"default-active":e.activeModule,class:"module-menu",onSelect:e.handleModuleChange,"background-color":"transparent","text-color":"#1f2d3d","active-text-color":"#409eff"},{default:a(()=>[(o(!0),r(V,null,D(e.moduleMenu,g=>(o(),S(c,{key:g.key,index:g.key},{default:a(()=>[s(f,{class:"menu-icon"},{default:a(()=>[(o(),S(A(g.icon)))]),_:2},1024),n("div",Fs,[n("span",Rs,_(g.label),1),n("span",Is,_(g.desc),1)])]),_:2},1032,["index"]))),128))]),_:1},8,["default-active","onSelect"]),n("div",zs,[s(d,{title:"提示：本系统仅提供辅助决策，请结合临床经验与检查结果。",type:"warning","show-icon":"",closable:!1,size:"small"})])]),n("section",Es,[s(ne,{name:"module-fade",mode:"out-in"},{default:a(()=>[(o(),S(A(e.activeModuleComponent),me({key:e.activeModule},e.moduleProps,he(e.moduleListeners),{class:"module-content"}),null,16))]),_:1})])])]),n("aside",As,[s(y,{onDensityChange:e.handleDensityChange,onOpenShortcuts:e.handleOpenShortcuts},null,8,["onDensityChange","onOpenShortcuts"])])])}const Os=U($s,[["render",Ls],["__scopeId","data-v-c8777e70"]]);export{Os as default};
